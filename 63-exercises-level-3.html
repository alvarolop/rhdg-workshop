<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Exercises: Level III :: RH Data Grid Workshop</title>
    <link rel="canonical" href="https://alvarolop.github.io/rhdg-workshop/63-exercises-level-3.html">
    <link rel="prev" href="62-exercises-level-2.html">
    <link rel="next" href="70-conclusions.html">
    <meta name="generator" content="Antora 3.0.3">
    <link rel="stylesheet" href="./_/css/site.css">
<link rel="icon" href="./_/img/favicon.ico" type="image/x-icon">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://developers.redhat.com" target="_blank"><img src="./_/img/RHDLogo.svg" height="40px" alt="Red Hat Developer Program"></a>
      <a class="navbar-item" style="font-size: 24px; color: white" href="https://alvarolop.github.io/rhdg-workshop">RH Data Grid Workshop</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="https://developers.redhat.com/ebooks/" target="_blank">Books</a>
        <a class="navbar-item" href="https://developers.redhat.com/cheatsheets/" target="_blank">Cheat Sheets</a>
        <a class="navbar-item" href="https://developers.redhat.com/events/" target="_blank">Upcoming Events</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">More Tutorials</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/quarkus-tutorial/" target="_blank">Quarkus</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/knative-tutorial/" target="_blank">Knative</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/kafka-tutorial/" target="_blank">Kafka</a>
            <a class="navbar-item" href="https://devsecops-workshop.github.io/" target="_blank">DevSecOps</a>
            <a class="navbar-item" href="https://acidonper.github.io/redhat-workshop-cicd-gitops/redhat-workshop-cicd-gitops/" target="_blank">CI/CD & GitOps</a>
            <a class="navbar-item" href="https://atarazana.github.io/gramola-gitops-guide/gramola-gitops-guide/" target="_blank">Gramola GitOps Guide</a>
            <a class="navbar-item" href="https://luisarizmendi.github.io/tutorial-secure-onboarding/" target="_blank">Secure Edge device onboarding with RHEL and FDO</a>
            <a class="navbar-item" href="https://xbryan1.github.io/rhte-2023-acm-docs/" target="_blank">Multicluster Application Deployment with Advanced Cluster Management and GitOps</a>
            <a class="navbar-item" href="https://redhat-scholars.github.io/java-inner-loop-dev-guide/java-inner-loop-dev-guide/index.html" target="_blank">Java Inner Loop Dev Guide</a>
          </div>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="ROOT" data-version="master">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html"></a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="10-introduction.html">1. Introduction</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="20-setup.html">2. Environment Setup</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">3. Server Configuration</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="31-server-configuration-basic.html">3.1. Initial Deployment</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="32-server-configuration-resources.html">3.2. Resourcing and labels</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="33-server-configuration-security.html">3.3. Security</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">4. Cache Configuration</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="40-cache-configuration-cache-crd.html">4.1. Cache CRD</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="41-cache-configuration-encoding.html">4.2. Encoding</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="42-cache-configuration-expiration.html">4.3. Expiration</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="43-cache-configuration-memory.html">4.4. Memory</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="44-cache-configuration-templates.html">4.5. Cache Templates</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">5. Troubleshooting</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="50-troubleshooting-basic.html">5.1. Basic Troubleshooting</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="51-troubleshooting-rest-api.html">5.2. REST to retrieve information</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="52-troubleshooting-jvm-debugging.html">5.3. JVM debugging</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="60-exercises.html">6. Exercises</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="61-exercises-level-1.html">6.1. Level I</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="62-exercises-level-2.html">6.2. Level II</a>
  </li>
  <li class="nav-item is-current-page" data-depth="2">
    <a class="nav-link" href="63-exercises-level-3.html">6.3. Level III</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="70-conclusions.html">7. Conclusions</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">RHDG Workshop</a></li>
    <li><a href="60-exercises.html">6. Exercises</a></li>
    <li><a href="63-exercises-level-3.html">6.3. Level III</a></li>
  </ul>
</nav>
  <div style="padding: 0 0.5rem 0 0.75rem;"><a href="https://github.com/alvarolop" target="_blank" rel="noopener noreferrer"> © 2023 - Álvaro López Medina</a></div>
</div>  <div class="content">
<article class="doc">
<h1 class="page">Exercises: Level III</h1>
<div class="sect1">
<h2 id="_3_1_datasources_with_sql_database"><a class="anchor" href="#_3_1_datasources_with_sql_database"></a>3.1. Datasources with SQL Database</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_step_1_deploy_a_postgresql_database"><a class="anchor" href="#_step_1_deploy_a_postgresql_database"></a>Step 1: Deploy a PostgreSQL database</h3>
<div class="paragraph">
<p>You already have one PostgreSQL database deployed as a single pod in another namespace: <code>$YOUR_NAME-db</code>.</p>
</div>
<div class="paragraph">
<p>Go to that namespace and check the logs of the pod. Check that there aren&#8217;t errors and that the logs show the following message:</p>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-log hljs" data-lang="log">Starting server...
2023-08-31 10:08:41.603 UTC [1] LOG: redirecting log output to logging collector process
2023-08-31 10:08:41.603 UTC [1] HINT: Future log output will appear in directory "log".</code></pre>
</div>
</div>
<div class="paragraph">
<p>This cluster has the following configuration that you will need in Step 3:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Username: <code>rhdguser</code>.</p>
</li>
<li>
<p>Password: <code>password</code>.</p>
</li>
<li>
<p>Database: <code>datagrid</code>.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_step_2_download_and_add_the_jdbc_driver_for_postgresql"><a class="anchor" href="#_step_2_download_and_add_the_jdbc_driver_for_postgresql"></a>Step 2: Download and add the JDBC driver for PostgreSQL</h3>
<div class="paragraph">
<p>For this exercise, I recommend you use the JDBC driver for PostgreSQL, which is easy to load and configure. You use JDBC connections with SQL cache stores and JDBC string-based caches stores. It can be downloaded from here: <a href="https://jdbc.postgresql.org/download/" class="bare">https://jdbc.postgresql.org/download/</a></p>
</div>
<div class="paragraph">
<p>We have to instruct RH Data Grid to download the binary and add it to the <code>server/lib</code> folder. This can be done easily with the following configuration:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: infinispan.org/v1
kind: Infinispan
metadata:
  name: cluster
spec:
  dependencies:
    artifacts:
      - maven: ''
        url: https://jdbc.postgresql.org/download/postgresql-42.6.0.jar</code></pre>
</div>
</div>
<div class="paragraph">
<p>If everything went fine, you should see the following line in the logs:</p>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-log hljs" data-lang="log">12:31:45,410 INFO  (main) [org.infinispan.SERVER] ISPN080027: Loaded extension 'org.postgresql.Driver'</code></pre>
</div>
</div>
<div class="exampleblock">
<div class="title"><strong>Now it&#8217;s your turn!</strong></div>
<div class="content">
<div class="paragraph">
<p>If you want to keep investigating this topic, it is possible to add the drivers using a mounted PVC where you previously copied the driver. This way, you don&#8217;t have any external dependencies during deploy time. You can try it using the following documentation: <a href="https://access.redhat.com/documentation/en-us/red_hat_data_grid/8.4/html-single/data_grid_operator_guide/index#copying-code_custom-code" class="bare">https://access.redhat.com/documentation/en-us/red_hat_data_grid/8.4/html-single/data_grid_operator_guide/index#copying-code_custom-code</a></p>
</div>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">Check that the JDBC driver was correctly added</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash"># If downloaded using the URL
oc exec -it cluster-0 -c infinispan -- ls /opt/infinispan/server/lib/external-artifacts/lib

# If mounted with the PVC
oc exec -it cluster-0 -c infinispan -- ls /opt/infinispan/server/lib</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_step_3_add_the_datasource_connector_configuration"><a class="anchor" href="#_step_3_add_the_datasource_connector_configuration"></a>Step 3: Add the Datasource connector configuration</h3>
<div class="paragraph">
<p>Data Grid allows you to create managed datasources as part of your Data Grid Server configuration to optimize connection pooling and performance for JDBC database connections. You can then specify the JDNI name of the managed datasources in your caches (Step 4), which centralizes JDBC connection configuration for your deployment.</p>
</div>
<div class="paragraph">
<p>Add the Connector configuration on the <code>infinispan.server.datasources</code> section of the ConfigMap:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: v1
kind: ConfigMap
metadata:
  name: cluster-custom-config
data:
  infinispan-config.yaml: &gt;
    infinispan:
      server:
        dataSources:
          - name: ds
            jndiName: 'jdbc/postgres'
            statistics: true
            connectionFactory:
              driver: "org.postgresql.Driver"
              url: "jdbc:postgresql://postgresql.$YOUR_USER-db.svc:5432/datagrid"
              username: "rhdguser"
              password: "password"
            connectionPool:
              initialSize: 1
              maxSize: 10
              minSize: 3
              backgroundValidation: 1000
              idleRemoval: 1
              blockingTimeout: 1000
              leakDetection: 10000
      cache-container:
      # Here the previous contents of the file #</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">Check that the datasource was correctly added:</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">curl -s -k -u admin:password $RHDG_URL/rest/v2/server/config | yq -P .</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_step_4_configure_the_caches_to_persist_data"><a class="anchor" href="#_step_4_configure_the_caches_to_persist_data"></a>Step 4: Configure the caches to persist data</h3>
<div class="paragraph">
<p>When you add a managed datasource to Data Grid Server you can add the JNDI name to a JDBC-based cache store configuration. Now, configure the <code>persistence</code> section of your cache. JDBC String-Based cache stores, JdbcStringBasedStore, use JDBC drivers to load and store values in the underlying database.</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: infinispan.org/v2alpha1
kind: Cache
metadata:
  name: cluster-datasource-cache
spec:
  clusterName: cluster
  name:  datasource-cache
  template: |-
    distributedCache:
      owners: "1"
      mode: SYNC
      statistics: "true"
      encoding:
        key:
          mediaType: application/x-protostream
        value:
          mediaType: application/x-protostream
      persistence:
        stringKeyedJdbcStore:
          dataSource:
            jndi-url: "jdbc/postgres"
          stringKeyedTable:
            prefix: "TBL"
            dropOnExit: true
            createOnStart: true
            idColumn:
              name: "ID"
              type: "VARCHAR(255)"
            dataColumn:
              name: "DATA"
              type: "BYTEA"
            timestampColumn:
              name: "TS"
              type: "BIGINT"
            segmentColumn:
              name: "S"
              type: "INT"
  updates:
    strategy: recreate</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now, add a new entry in the cache (For example, using the web console) and check that it is correctly added to the cache and to the data store:</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">Check</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash"># Check current Databases (Should show "datagrid")
psql postgres://rhdguser:password@localhost:5432/datagrid -c '\l'

# Check cache statistics
curl -s -k -u admin:password $RHDG_URL/rest/v2/caches/datasource-cache | yq -P .

# Check DB table contents
psql postgres://rhdguser:password@localhost:5432/datagrid -c 'SELECT * FROM "TBL_datasource_cache";'
   id   |                                                                          data                                                                          | ts |  s
--------+--------------------------------------------------------------------------------------------------------------------------------------------------------+----+-----
  8SgFj | \x9801ea078a01430a0b98010b8a01050a034a0164121c9801058a011618ffffffffffffffffff0120ffffffffffffffffff0118ffffffffffffffffff0120ffffffffffffffffff012a00 | -1 | 231
(1 row)</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="exampleblock">
<div class="title"><strong>Now it&#8217;s your turn!</strong></div>
<div class="content">
<div class="paragraph">
<p><strong>Exercise 1</strong></p>
</div>
<div class="paragraph">
<p>Do you want to keep learning about this topic? You should learn about Passivation. Passivation configures Data Grid to write entries to cache stores when it evicts those entries from memory. In this way, passivation ensures that only a single copy of an entry is maintained, either in-memory or in a cache store, which prevents unnecessary and potentially expensive writes to persistent storage.</p>
</div>
<div class="paragraph">
<p>Please, check this <a href="https://access.redhat.com/documentation/en-us/red_hat_data_grid/8.4/html-single/configuring_data_grid_caches/index#passivation_persistence">documentation</a> and configure Passivation in your cache.</p>
</div>
<div class="paragraph">
<p><strong>Exercise 2</strong></p>
</div>
<div class="paragraph">
<p>On top of that, if you are not interested in Passivation on a DB, but just on a local file, you can configure a Soft-Index File Stores. Check this <a href="https://access.redhat.com/documentation/en-us/red_hat_data_grid/8.4/html-single/configuring_data_grid_caches/index#file-stores_persistence">documentation</a> to configure passivation on file.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_where_can_i_get_more_info"><a class="anchor" href="#_where_can_i_get_more_info"></a>Where can I get more info?</h3>
<div class="paragraph">
<p>The documentation is split into several documents according to the topic:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Operator: <a href="https://access.redhat.com/documentation/en-us/red_hat_data_grid/8.4/html-single/data_grid_operator_guide/index#deploying-code">Deploying custom code to Data Grid</a>. This chapter helps you to add the JDBC driver to the Data Grid container during startup.</p>
</li>
<li>
<p>Server: <a href="https://access.redhat.com/documentation/en-us/red_hat_data_grid/8.4/html-single/data_grid_server_guide/index#managed-datasources">Adding managed datasources to Data Grid Server</a>: To configure data sources that will then be consumed from caches.</p>
</li>
<li>
<p>Caches: <a href="https://access.redhat.com/documentation/en-us/red_hat_data_grid/8.4/html/configuring_data_grid_caches/persistence#doc-wrapper">Configuring persistent storage</a>. This chapter explains the configuration related to configuring persistence and passivation of cache entries.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="authorization-using-rbac"><a class="anchor" href="#authorization-using-rbac"></a>3.2. Authorization using RBAC</h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="_3_3_cross_site_replication"><a class="anchor" href="#_3_3_cross_site_replication"></a>3.3. Cross-site replication</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Finally, we unravel the complexities of cross-site data replication within your cluster. This advanced feature ties together all the previous sections, showcasing how the cumulative knowledge gained contributes to a robust cache optimization strategy.</p>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="62-exercises-level-2.html">6.2. Level II</a></span>
  <span class="next"><a href="70-conclusions.html">7. Conclusions</a></span>
</nav>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer">
  <a class="rhd-logo" href="https://developers.redhat.com" target="_blank"></div>
</footer>
<script src="./_/js/vendor/clipboard.js"></script>
<script src="./_/js/site.js"></script>
<script async src="./_/js/vendor/highlight.js"></script>
  </body>
</html>
