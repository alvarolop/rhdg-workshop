<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Cache Configuration :: RH Data Grid Workshop</title>
    <link rel="canonical" href="https://alvarolop.github.io/rhdg-workshop/40-cache-configuration.html">
    <link rel="prev" href="32-server-configuration-security.html">
    <link rel="next" href="50-troubleshooting.html">
    <meta name="generator" content="Antora 3.0.3">
    <link rel="stylesheet" href="./_/css/site.css">
<link rel="icon" href="./_/img/favicon.ico" type="image/x-icon">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://developers.redhat.com" target="_blank"><img src="./_/img/RHDLogo.svg" height="40px" alt="Red Hat Developer Program"></a>
      <a class="navbar-item" style="font-size: 24px; color: white" href="https://alvarolop.github.io/rhdg-workshop">RH Data Grid Workshop</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="https://developers.redhat.com/ebooks/" target="_blank">Books</a>
        <a class="navbar-item" href="https://developers.redhat.com/cheatsheets/" target="_blank">Cheat Sheets</a>
        <a class="navbar-item" href="https://developers.redhat.com/events/" target="_blank">Upcoming Events</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">More Tutorials</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/quarkus-tutorial/" target="_blank">Quarkus</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/knative-tutorial/" target="_blank">Knative</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/kafka-tutorial/" target="_blank">Kafka</a>
            <a class="navbar-item" href="https://devsecops-workshop.github.io/" target="_blank">DevSecOps</a>
            <a class="navbar-item" href="https://acidonper.github.io/redhat-workshop-cicd-gitops/redhat-workshop-cicd-gitops/" target="_blank">CI/CD & GitOps</a>
            <a class="navbar-item" href="https://atarazana.github.io/gramola-gitops-guide/gramola-gitops-guide/" target="_blank">Gramola GitOps Guide</a>
            <a class="navbar-item" href="https://luisarizmendi.github.io/tutorial-secure-onboarding/" target="_blank">Secure Edge device onboarding with RHEL and FDO</a>
            <a class="navbar-item" href="https://xbryan1.github.io/rhte-2023-acm-docs/" target="_blank">Multicluster Application Deployment with Advanced Cluster Management and GitOps</a>
            <a class="navbar-item" href="https://redhat-scholars.github.io/java-inner-loop-dev-guide/java-inner-loop-dev-guide/index.html" target="_blank">Java Inner Loop Dev Guide</a>
          </div>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="ROOT" data-version="master">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html"></a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="10-introduction.html">1. Introduction</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="20-setup.html">2. Environment Setup</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="20-setup.html#prerequisite">Prerequisites</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="20-setup.html#access-console">Access - OCP Console</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="20-setup.html#access-cli">Access - OC Client</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">3. Server Configuration</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="31-server-configuration-basic.html">3.1. Basic Configuration</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="32-server-configuration-security.html">3.2. Security</a>
  </li>
</ul>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <a class="nav-link" href="40-cache-configuration.html">4. Cache Configuration</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="50-troubleshooting.html">5. Troubleshooting</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="60-exercises.html">6. Exercises</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="70-conclusions.html">7. Conclusions</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">RHDG Workshop</a></li>
    <li><a href="40-cache-configuration.html">4. Cache Configuration</a></li>
  </ul>
</nav>
  <div style="padding: 0 0.5rem 0 0.75rem;"><a href="https://github.com/alvarolop" target="_blank" rel="noopener noreferrer"> © 2023 - Álvaro López Medina</a></div>
</div>  <div class="content">
<article class="doc">
<h1 class="page">Cache Configuration</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>Alright, we&#8217;re all set! Our server is up and running smoothly, with foundational settings neatly configured. It might be tempting to consider this sufficient for a Data Grid administrator. But beneath the surface lies a more intricate narrative.</p>
</div>
<div class="paragraph">
<p>In the realm of Data Grid, the information takes residence within caches, whose configuration is typically a terrain overseen by development teams. However, the configuration of these caches holds the potential to profoundly influence your infrastructure&#8217;s performance. That&#8217;s precisely why it&#8217;s essential to delve into mastering the cache main settings.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_caches_in_openshift"><a class="anchor" href="#_caches_in_openshift"></a>Caches in Openshift</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Multiple mechanisms are available to create caches within a Data Grid cluster deployed on Openshift. You have the option to use traditional methods employed in Data Grid, such as the REST endpoint, Infinispan CLI, or the server configuration file loaded during startup. However, the most effective mechanism when utilizing the operator is the Cache CRD. This Custom Resource offers full configurational flexibility, while the operator constantly monitors changes in cache configuration and promptly synchronizes them with the server.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Data Grid accommodates cache and server configuration in XML, YAML, and JSON formats. The choice between these formats is a matter of personal preference. However, for the purpose of this workshop, given that we deploy on Openshift, all the examples utilize the YAML format.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Let&#8217;s create the first cache of the cluster. To do so, you just need to create the Cache CR object with the cache configuration and set the cluster where you want it to be configured.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">Cache modes</div>
Remember that there are two main cache modes: Replicated and Distributed. The main difference is that replicated caches store a copy of each cache key in each node of the cluster, while Distributed caches just store N copies, determined by the <code>owners</code> field in the configuration. For the sake of simplicity, we are going to use <code>replicated-cache</code> in this workshop, but all cache configurations would be valid for <code>distributed-cache</code>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>We are going to use one of the simplest cache configurations: Replicated cache in SYNC mode and statistics enabled.</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: infinispan.org/v2alpha1
kind: Cache
metadata:
  name: cluster-cache-replicated-01
spec:
  clusterName: cluster
  name:  cache-replicated-01
  template: |-
    replicatedCache:
      mode: "SYNC"
      statistics: "true"
  updates:
    strategy: recreate</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now, please, access the web console again and check that the cache is configured. Also note that, based on your configuration, the cache is labeled with the most important features. Now, click on the cache name to explore all the information that the server can provide. You will notice that the server complains that you did not define an encoding configuration. Without it, you will lose some great features and you won&#8217;t be able to store entries in the cache, so let&#8217;s do it now!</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_encoding"><a class="anchor" href="#_encoding"></a>Encoding</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Encoding is the format, identified by a media-type, that Data Grid uses to store entries (key/value pairs) in caches. You will have mainly two options:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Protobuf: To optimize speed, ensure interoperability, perform queries on the data, or use the web console to check the cache contents.</p>
</li>
<li>
<p>Java Serialization: This option simplifies the configuration of the Java client and server with the disadvantage of losing the benefits of the previous option.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Let&#8217;s define the encoding format for both the key and the value of all the entries of the cache. By updating the cache definition with the following configuration:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: infinispan.org/v2alpha1
kind: Cache
metadata:
  name: cluster-cache-replicated-01
spec:
  clusterName: cluster
  name:  cache-replicated-01
  template: |-
    replicatedCache:
      mode: "SYNC"
      statistics: "true"
      encoding:
        key:
          mediaType: application/x-protostream
        value:
          mediaType: application/x-protostream
  updates:
    strategy: recreate</code></pre>
</div>
</div>
<div class="paragraph">
<p>Great! Now, you can access the web console again. Navigate to the cache that you just updated and you will see that there is a new tab called <code>Entries</code>.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/40-cache-rhdg-console-cache-entries.png" alt="40 cache rhdg console cache entries">
</div>
<div class="title">Figure 1. View in the web console of the entries of a cache</div>
</div>
<div class="paragraph">
<p>This tab allows you to explore the cached content and add new entries if you are allowed to. Try it now! If you cannot see the <code>Add entry</code> button, make sure that you are logged in as the <code>admin</code> user.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/40-cache-rhdg-console-cache-new-entry.png" alt="40 cache rhdg console cache new entry">
</div>
<div class="title">Figure 2. Web form to add entries to a cache</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_expiration"><a class="anchor" href="#_expiration"></a>Expiration</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Old stuff isn&#8217;t always useful. We&#8217;ll show you how to set a timer. The Expiration section instructs Data Grid to remove entries from caches when they reach their time limit regarding expiration or idling.</p>
</div>
<div class="paragraph">
<p>For this purpose, we will reuse the same cache and modify it to add the new configuration:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: infinispan.org/v2alpha1
kind: Cache
metadata:
  name: cluster-cache-replicated-01
spec:
  clusterName: cluster
  name:  cache-replicated-01
  template: |-
    replicatedCache:
      mode: "SYNC"
      statistics: "true"
      encoding:
        key:
          mediaType: application/x-protostream
        value:
          mediaType: application/x-protostream
      expiration:
        lifespan: "60000"
  updates:
    strategy: recreate</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now, access the web console again and add a second entry. You will notice that new entries will have the configured expiration time, while the old ones are kept forever. There are mechanisms to make sure that all existing entries will expire after the expiration time set in the configuration.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/40-cache-rhdg-console-cache-expiration.png" alt="40 cache rhdg console cache expiration">
</div>
<div class="title">Figure 3. View entries in the web console with its expiration time</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_memory"><a class="anchor" href="#_memory"></a>Memory</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The memory section lets you control the size of the data container by removing entries from memory when a memory or count limit is reached.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
As the <code>spec.updates.strategy</code> is set to recreate, the operator will remove the cache from the cluster and create it again, so all the entries that you had created will be lost. We can discuss, if you want, the possible reasons and mitigation behind this decision.
</td>
</tr>
</table>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: infinispan.org/v2alpha1
kind: Cache
metadata:
  name: cluster-cache-replicated-01
spec:
  clusterName: cluster
  name:  cache-replicated-01
  template: |-
    replicatedCache:
      mode: "SYNC"
      statistics: "true"
      encoding:
        key:
          mediaType: application/x-protostream
        value:
          mediaType: application/x-protostream
      expiration:
        lifespan: "60000"
      memory:
        maxSize: "200MB"
        whenFull: "REMOVE"
  updates:
    strategy: recreate</code></pre>
</div>
</div>
<div class="paragraph">
<p>We are not going to test this limit, but I guess that you trust me :) If not, I recommend you try the <code>maxCount</code> limit with an extremely low threshold and add enough entries so that the cluster has to remove some of the existing ones.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_cache_templates"><a class="anchor" href="#_cache_templates"></a>Cache Templates</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Templates make life easier. You can set up common settings that caches can borrow or even modify according to specific needs. This is useful if you want to simplify the onboarding of new teams or keep consistency between cache definitions.</p>
</div>
<div class="paragraph">
<p>The only downside is that, in order to inherit the cache template from a Cache definition, it has to be defined upfront. The simplest way of doing so is to configure templates using the ConfigMap loaded at startup instead of using the <code>Cache</code> CRD. How to do it? It is easy, it just needs three steps:</p>
</div>
<div class="paragraph">
<p><strong>Step 1: Create a new ConfigMap with the server configuration</strong></p>
</div>
<div class="paragraph">
<p>First, we need to create a new ConfigMap that will add server configuration that will be combined with the configuration injected by the operator in the pod. The contents of this file are pretty large, so, for now, we will just need to know that we can add caches in that file.</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: v1
kind: ConfigMap
metadata:
  name: cluster-custom-config
data:
  infinispan-config.yaml: &gt;
    infinispan:
      cache-container:
        name: "default"
        statistics: "true"
        replicatedCacheConfiguration:
          name: "proto-repl-small-template"
          mode: "SYNC"
          statistics: "true"
          encoding:
            key:
              mediaType: application/x-protostream
            value:
              mediaType: application/x-protostream
          expiration:
            lifespan: "5000"
            maxIdle: "1000"
          memory:
            maxCount: "10"
            whenFull: "REMOVE"
        replicatedCacheConfiguration:
          name: "proto-repl-big-template"
          mode: "SYNC"
          statistics: "true"
          encoding:
            key:
              mediaType: application/x-protostream
            value:
              mediaType: application/x-protostream
          expiration:
            lifespan: "5000"
            maxIdle: "1000"
          memory:
            maxCount: "1000"
            whenFull: "REMOVE"</code></pre>
</div>
</div>
<div class="paragraph">
<p>This ConfigMap just defines two cache sizes that developers will then be able to use in their applications. The only difference is that one is limited to 10 entries while the other can hold until 1000.</p>
</div>
<div class="paragraph">
<p><strong>Step 2: Configure the Infinispan CR to use the new ConfigMap</strong></p>
</div>
<div class="paragraph">
<p>Now, just instruct the Infinispan CR to mount that ConfigMap in the pod and combine the existing server configuration with the new one.</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: infinispan.org/v1
kind: Infinispan
metadata:
  name: cluster
spec:
  configMapName: cluster-custom-config</code></pre>
</div>
</div>
<div class="paragraph">
<p>Wait a few seconds until all the pods restart with the new configuration. Then, log in to the Web Console. In the main dashboard, you will see the <code>Display cache templates</code> button. Access that link to see your templates.</p>
</div>
<div class="paragraph">
<p><strong>Step 3: Create a new cache using the template</strong></p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: infinispan.org/v2alpha1
kind: Cache
metadata:
  name: cluster-cache-replicated-02
spec:
  clusterName: cluster
  name:  cache-replicated-02
  templateName: proto-repl-small-template
  updates:
    strategy: recreate</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Are you interested in inheriting cache configuration but overriding any of its values? You can do it using the same mechanism. Check this <a href="https://access.redhat.com/documentation/en-us/red_hat_data_grid/8.4/html-single/configuring_data_grid_caches/index#cache-templates_cache-configuration">link</a> to the official documentation.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_wrap_up"><a class="anchor" href="#_wrap_up"></a>Wrap Up!</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Wrapping up this chapter, we&#8217;ve laid a solid groundwork for navigating Red Hat Data Grid&#8217;s cache settings. Understanding cache configuration, templates, encoding, expiration, and eviction is key to optimizing your caches. Armed with this knowledge, you&#8217;re equipped to fine-tune your cache setup, ensuring efficiency and smooth operation. As we move forward, remember that these foundational insights will serve as a springboard to more advanced cache strategies and optimizations.</p>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="32-server-configuration-security.html">3.2. Security</a></span>
  <span class="next"><a href="50-troubleshooting.html">5. Troubleshooting</a></span>
</nav>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer">
  <a class="rhd-logo" href="https://developers.redhat.com" target="_blank"></div>
</footer>
<script src="./_/js/vendor/clipboard.js"></script>
<script src="./_/js/site.js"></script>
<script async src="./_/js/vendor/highlight.js"></script>
  </body>
</html>
