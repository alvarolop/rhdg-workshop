<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Exercises: Level II :: RH Data Grid Workshop</title>
    <link rel="canonical" href="https://alvarolop.github.io/rhdg-workshop/62-exercises-level-2.html">
    <link rel="prev" href="61-exercises-level-1.html">
    <link rel="next" href="63-exercises-level-3.html">
    <meta name="generator" content="Antora 3.0.3">
    <link rel="stylesheet" href="./_/css/site.css">
<link rel="icon" href="./_/img/favicon.ico" type="image/x-icon">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://developers.redhat.com" target="_blank"><img src="./_/img/RHDLogo.svg" height="40px" alt="Red Hat Developer Program"></a>
      <a class="navbar-item" style="font-size: 24px; color: white" href="https://alvarolop.github.io/rhdg-workshop">RH Data Grid Workshop</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="https://developers.redhat.com/ebooks/" target="_blank">Books</a>
        <a class="navbar-item" href="https://developers.redhat.com/cheatsheets/" target="_blank">Cheat Sheets</a>
        <a class="navbar-item" href="https://developers.redhat.com/events/" target="_blank">Upcoming Events</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">More Tutorials</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/quarkus-tutorial/" target="_blank">Quarkus</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/knative-tutorial/" target="_blank">Knative</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/kafka-tutorial/" target="_blank">Kafka</a>
            <a class="navbar-item" href="https://devsecops-workshop.github.io/" target="_blank">DevSecOps</a>
            <a class="navbar-item" href="https://acidonper.github.io/redhat-workshop-cicd-gitops/redhat-workshop-cicd-gitops/" target="_blank">CI/CD & GitOps</a>
            <a class="navbar-item" href="https://atarazana.github.io/gramola-gitops-guide/gramola-gitops-guide/" target="_blank">Gramola GitOps Guide</a>
            <a class="navbar-item" href="https://luisarizmendi.github.io/tutorial-secure-onboarding/" target="_blank">Secure Edge device onboarding with RHEL and FDO</a>
            <a class="navbar-item" href="https://xbryan1.github.io/rhte-2023-acm-docs/" target="_blank">Multicluster Application Deployment with Advanced Cluster Management and GitOps</a>
            <a class="navbar-item" href="https://redhat-scholars.github.io/java-inner-loop-dev-guide/java-inner-loop-dev-guide/index.html" target="_blank">Java Inner Loop Dev Guide</a>
          </div>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="ROOT" data-version="master">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html"></a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="10-introduction.html">1. Introduction</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="20-setup.html">2. Environment Setup</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">3. Server Configuration</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="31-server-configuration-basic.html">3.1. Initial Deployment</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="32-server-configuration-resources.html">3.2. Resourcing and labels</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="33-server-configuration-security.html">3.3. Security</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">4. Cache Configuration</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="40-cache-configuration-cache-crd.html">4.1. Cache CRD</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="41-cache-configuration-encoding.html">4.2. Encoding</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="42-cache-configuration-expiration.html">4.3. Expiration</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="43-cache-configuration-memory.html">4.4. Memory</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="44-cache-configuration-templates.html">4.5. Cache Templates</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">5. Troubleshooting</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="50-troubleshooting-basic.html">5.1. Basic Troubleshooting</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="51-troubleshooting-rest-api.html">5.2. REST to retrieve information</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="52-troubleshooting-jvm-debugging.html">5.3. JVM debugging</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="60-exercises.html">6. Exercises</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="61-exercises-level-1.html">6.1. Level I</a>
  </li>
  <li class="nav-item is-current-page" data-depth="2">
    <a class="nav-link" href="62-exercises-level-2.html">6.2. Level II</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="63-exercises-level-3.html">6.3. Level III</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="70-conclusions.html">7. Conclusions</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">RHDG Workshop</a></li>
    <li><a href="60-exercises.html">6. Exercises</a></li>
    <li><a href="62-exercises-level-2.html">6.2. Level II</a></li>
  </ul>
</nav>
  <div style="padding: 0 0.5rem 0 0.75rem;"><a href="https://github.com/alvarolop" target="_blank" rel="noopener noreferrer"> © 2023 - Álvaro López Medina</a></div>
</div>  <div class="content">
<article class="doc">
<h1 class="page">Exercises: Level II</h1>
<div class="sect1">
<h2 id="_2_1_rest_api_for_caches"><a class="anchor" href="#_2_1_rest_api_for_caches"></a>2.1. REST API for Caches</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Learn how to work with Caches using the REST API and various data formats.</p>
</div>
<div class="paragraph">
<p><strong>First</strong>, you will need to create three caches with similar configuration. Use the knowledge of the section <code>Cache Configuration</code> to create three caches with its corresponding encoding format:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>rest-plain</code>: Encoding <code>text/plain</code>.</p>
</li>
<li>
<p><code>rest-json</code>: Encoding <code>application/json</code>.</p>
</li>
<li>
<p><code>rest-proto</code>: Encoding <code>application/x-protostream</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>You can use either the Cache CR, the REST API, etc. <a href="https://access.redhat.com/documentation/en-us/red_hat_data_grid/8.4/html/data_grid_rest_api/rest_v2_api#rest_v2_create_cache">Here</a> is how to create a cache using the REST API.</p>
</div>
<div class="paragraph">
<p>Use the command you learned in the Troubleshooting section to check that the caches are present in the cluster.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
I recommend you use the same configuration for all of them. Use a Distributed cache with two owners. Avoid setting expiration and memory. Just keep it simple! You can use the official documentation for <a href="https://access.redhat.com/documentation/en-us/red_hat_data_grid/8.4/html/configuring_data_grid_caches/index">Cache Configuration</a> and for <a href="https://access.redhat.com/documentation/en-us/red_hat_data_grid/8.4/html-single/cache_encoding_and_marshalling/index#cache-encoding">Encoding and Marshalling</a>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><strong>Second</strong>, you will create entries in all three caches in different formats depending on the cache encoding:</p>
</div>
<div class="listingblock console-input">
<div class="title">Put an entry in the cache</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash"># text/plain
curl -X POST -k -u admin:password -H "Content-Type: text/plain" $RHDG_URL/rest/v2/caches/rest-plain/0 --data "Hello World"

# application/json
curl -X POST -k -u admin:password -H "Content-Type: application/json" $RHDG_URL/rest/v2/caches/rest-json/0 --data '{"Hello": "World", "foo": "bar", "john": "doe"}'

# application/x-protostream
curl -X POST -k -u admin:password -H "Content-Type: text/plain" $RHDG_URL/rest/v2/caches/rest-proto/0 --data "Hello World"</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Third</strong>, retrieve the entries also using the REST API.</p>
</div>
<div class="listingblock console-input">
<div class="title">Retrieve entries from the cache</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash"># text/plain
curl -X GET -k -u admin:password -H "Content-Type: text/plain" $RHDG_URL/rest/v2/caches/rest-plain/0

# application/json
curl -X GET -k -u admin:password -H "Content-Type: application/json" $RHDG_URL/rest/v2/caches/rest-json/0 | jq .
{
  "Hello": "World",
  "foo": "bar",
  "john": "doe"
}

# application/x-protostream
curl -X GET -k -u admin:password -H "Content-Type: text/plain" $RHDG_URL/rest/v2/caches/rest-proto/0 | jq .
{
  "_type": "string",
  "_value": "Hello World"
}</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
See how, with a proto cache, you can interact with <code>text/plain</code> format in your REST queries, but it then stores the entries in Protostream format. This simplifies interoperability and allows you to consume it as Java Objects directly from a Java Hot Rod client.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Congratulations! Now you are capable of interacting with caches from the REST API to check performance and configuration issues.</p>
</div>
<div class="exampleblock">
<div class="title"><strong>Now it&#8217;s your turn!</strong></div>
<div class="content">
<div class="paragraph">
<p>Please, keep exploring all the capabilities of the REST API. Try to query one of those Caches, retrieve the statistics for every hit and miss, etc.</p>
</div>
<div class="paragraph">
<p>In general, developers will use Protostream to store complex classes defined with a <code>.proto</code> file. Please, check how to create and delete <code>.proto</code> files with the REST API. Then, interact with the cache in the same way.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_2_2_deploying_a_java_client"><a class="anchor" href="#_2_2_deploying_a_java_client"></a>2.2. Deploying a Java client</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This workshop is focused on the infrastructure side of Data Grid, but maybe you are curious about the development side. Would you like to learn:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>How to deploy a Java Hot Rod client on Openshift.</p>
</li>
<li>
<p>How to configure a Java Spring Boot client to connect to a Data Grid cluster.</p>
</li>
<li>
<p>How to create caches automatically from the client application without a Cache CR.</p>
</li>
<li>
<p>How to upload proto schemas using the REST API.</p>
</li>
<li>
<p>How to perform puts, gets, queries, transactions, and listeners from an application perspective.</p>
</li>
<li>
<p>And much more?</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In such a case, I strongly recommend you check the following GitHub repository where we have an example application and all the Openshift resources to deploy an RHDG client in a few steps: <a href="https://github.com/alvarolop/rhdg8-client#42-run-it-on-openshift" class="bare">https://github.com/alvarolop/rhdg8-client#42-run-it-on-openshift</a></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_2_3_ldap_based_authorization"><a class="anchor" href="#_2_3_ldap_based_authorization"></a>2.3. LDAP-based Authorization</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Okay! In the <a href="33-server-configuration-security.html" class="xref page">Security Section</a>, we explored how to configure authentication and authorization in Data Grid based on the most basic Security Realm, the <code>Properties realm</code>. While it is easy to configure and use, the main disadvantage is that modifying users and roles implies a restart of the server pods to update the Secret.</p>
</div>
<div class="paragraph">
<p>In this section, we will explore the LDAP realm. The LDAP realm connects to LDAP servers, such as OpenLDAP, Red Hat Directory Server, Apache Directory Server, or Microsoft Active Directory, to authenticate users and obtain membership information.</p>
</div>
<div class="paragraph">
<p>In order to simplify the deployment and configuration, a shared OpenLDAP deployment is running in the <code>openldap</code> namespace in Openshift. It is already preconfigured with a set of users and clients. There is a tree with <code>users</code> belonging to <code>groups</code> for real employees that log in to the Data Grid cluster, and <code>clients</code> belonging to <code>roles</code> for client applications accessing Data Grid using Hot Rod.</p>
</div>
<div class="listingblock">
<div class="title">LDAP users</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">dn: dc=acme,dc=org

dn: ou=people,dc=acme,dc=org
    dn: uid=user-01,ou=people,dc=acme,dc=org
    dn: uid=user-02,ou=people,dc=acme,dc=org

dn: ou=groups,dc=acme,dc=org
    dn: cn=developer,ou=groups,dc=acme,dc=org
        member: uid=user-01,ou=people,dc=acme,dc=org
    dn: cn=admin,ou=groups,dc=acme,dc=org
        member: uid=user-02,ou=people,dc=acme,dc=org</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">LDAP clients</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">dn: dc=acme,dc=org

dn: ou=clients,dc=acme,dc=org
    dn: uid=client-01,ou=clients,dc=acme,dc=org
    dn: uid=client-02,ou=clients,dc=acme,dc=org
    dn: uid=client-11,ou=clients,dc=acme,dc=org
    dn: uid=client-12,ou=clients,dc=acme,dc=org

dn: ou=roles,dc=acme,dc=org
    dn: cn=normalusers,ou=roles,dc=acme,dc=org
        member: uid=client-01,ou=clients,dc=acme,dc=org
        member: uid=client-02,ou=clients,dc=acme,dc=org

    dn: cn=admin,ou=roles,dc=acme,dc=org
        member: uid=client-11,ou=clients,dc=acme,dc=org
        member: uid=client-12,ou=clients,dc=acme,dc=org</code></pre>
</div>
</div>
<div class="paragraph">
<p>The operator does not provide the capability to configure the LDAP realm using the operator. However, this is not an issue, as you can use the <code>.spec.configMapName</code> field of the Infinispan CR to inject or override almost any kind of Data Grid configuration during the server startup.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Do not remove the cache templates configuration, just add this LDAP configuration in the same ConfigMap!
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><strong>How can I do it?</strong></p>
</div>
<div class="paragraph">
<p>Go to the <a href="https://access.redhat.com/documentation/en-us/red_hat_data_grid/8.4/html-single/data_grid_security_guide/index#ldap-security-realms_security-realms">LDAP realm</a> official documentation and check the proposed configuration in YAML.</p>
</div>
<div class="paragraph">
<p>What you will do is override the <code>default</code> Realm Configuration that the operator autogenerates. For that, you just need to add your configuration under the following structure:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">infinispan:
  server:
    security:
      securityRealms:
        - name: default
          serverIdentities:
            ssl:
              keystore:
                path: "/etc/security/conf/operator-security/keystore.pem"
                keystorePassword: ""
          ldapRealm:
          # Here is the LDAP config
    endpoints:
    # Here is the Endpoints config explained below.
  cache-container:
  # Here is the previously configured Cache Templates</code></pre>
</div>
</div>
<div class="paragraph">
<p>You will need to perform several modifications to make it work:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>url</code>: The OpenLDAP server is exposed with a service at <code>server.openldap.svc</code>.</p>
</li>
<li>
<p><code>principal</code>: This is the admin user: <code>cn=admin,dc=acme,dc=org</code>.</p>
</li>
<li>
<p><code>credential</code>: This is the admin password: <code>adminpassword</code>.</p>
</li>
<li>
<p>Inside the <code>identityMapping</code> section, you will need to make the match between groups and roles. Make the query to transform the membership of a group to a Data Grid role. To simplify the conversion, the OpenLDAP group <code>admin</code> will easily transform to the Data Grid <code>admin</code> role with the correct query.</p>
</li>
<li>
<p>You need to add the following configuration under the <code>identityMapping</code> section:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">  ldapRealm:
    identityMapping:
      userPasswordMapper:
        from: "userPassword"</code></pre>
</div>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>If you are going to use <code>directVerification</code>, you need to change the auth mechanisms to use those that provide the password in clear text. Add the following to your Data Grid configuration in the appropriate section:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">infinispan:
  server:
    endpoints:
      endpoint:
        socketBinding: default
        securityRealm: default
        hotrodConnector:
          authentication:
            securityRealm: default
            sasl:
              serverName: infinispan
              mechanisms:
                - PLAIN
              qop:
                - auth
        restConnector:
          authentication:
            securityRealm: default
            mechanisms:
              - DIGEST
              - BASIC</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>How to test it?</strong></p>
</div>
<div class="paragraph">
<p>Just repeat any of the REST requests or access the Web Console and try to log in with the new users. The old ones should not be valid anymore.</p>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="61-exercises-level-1.html">6.1. Level I</a></span>
  <span class="next"><a href="63-exercises-level-3.html">6.3. Level III</a></span>
</nav>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer">
  <a class="rhd-logo" href="https://developers.redhat.com" target="_blank"></div>
</footer>
<script src="./_/js/vendor/clipboard.js"></script>
<script src="./_/js/site.js"></script>
<script async src="./_/js/vendor/highlight.js"></script>
  </body>
</html>
