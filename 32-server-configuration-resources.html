<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Basic Configuration :: RH Data Grid Workshop</title>
    <link rel="canonical" href="https://alvarolop.github.io/rhdg-workshop/32-server-configuration-resources.html">
    <link rel="prev" href="31-server-configuration-basic.html">
    <link rel="next" href="33-server-configuration-security.html">
    <meta name="generator" content="Antora 3.0.3">
    <link rel="stylesheet" href="./_/css/site.css">
<link rel="icon" href="./_/img/favicon.ico" type="image/x-icon">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://developers.redhat.com" target="_blank"><img src="./_/img/RHDLogo.svg" height="40px" alt="Red Hat Developer Program"></a>
      <a class="navbar-item" style="font-size: 24px; color: white" href="https://alvarolop.github.io/rhdg-workshop">RH Data Grid Workshop</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="https://developers.redhat.com/ebooks/" target="_blank">Books</a>
        <a class="navbar-item" href="https://developers.redhat.com/cheatsheets/" target="_blank">Cheat Sheets</a>
        <a class="navbar-item" href="https://developers.redhat.com/events/" target="_blank">Upcoming Events</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">More Tutorials</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/quarkus-tutorial/" target="_blank">Quarkus</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/knative-tutorial/" target="_blank">Knative</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/kafka-tutorial/" target="_blank">Kafka</a>
            <a class="navbar-item" href="https://devsecops-workshop.github.io/" target="_blank">DevSecOps</a>
            <a class="navbar-item" href="https://acidonper.github.io/redhat-workshop-cicd-gitops/redhat-workshop-cicd-gitops/" target="_blank">CI/CD & GitOps</a>
            <a class="navbar-item" href="https://atarazana.github.io/gramola-gitops-guide/gramola-gitops-guide/" target="_blank">Gramola GitOps Guide</a>
            <a class="navbar-item" href="https://luisarizmendi.github.io/tutorial-secure-onboarding/" target="_blank">Secure Edge device onboarding with RHEL and FDO</a>
            <a class="navbar-item" href="https://xbryan1.github.io/rhte-2023-acm-docs/" target="_blank">Multicluster Application Deployment with Advanced Cluster Management and GitOps</a>
            <a class="navbar-item" href="https://redhat-scholars.github.io/java-inner-loop-dev-guide/java-inner-loop-dev-guide/index.html" target="_blank">Java Inner Loop Dev Guide</a>
          </div>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="ROOT" data-version="master">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html"></a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="10-introduction.html">1. Introduction</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="20-setup.html">2. Environment Setup</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">3. Server Configuration</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="31-server-configuration-basic.html">3.1. Initial Deployment</a>
  </li>
  <li class="nav-item is-current-page" data-depth="2">
    <a class="nav-link" href="32-server-configuration-resources.html">3.2. Resourcing and labels</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="33-server-configuration-security.html">3.3. Security</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">4. Cache Configuration</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="40-cache-configuration-cache-crd.html">4.1. Cache CRD</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="41-cache-configuration-encoding.html">4.2. Encoding</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="42-cache-configuration-expiration.html">4.3. Expiration</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="43-cache-configuration-memory.html">4.4. Memory</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="44-cache-configuration-templates.html">4.5. Cache Templates</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">5. Troubleshooting</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="50-troubleshooting-basic.html">5.1. Basic Troubleshooting</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="51-troubleshooting-rest-api.html">5.2. REST to retrieve information</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="52-troubleshooting-jvm-debugging.html">5.3. JVM debugging</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="60-exercises.html">6. Exercises</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="61-exercises-level-1.html">6.1. Level I</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="62-exercises-level-2.html">6.2. Level II</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="63-exercises-level-3.html">6.3. Level III</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="70-conclusions.html">7. Conclusions</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">RHDG Workshop</a></li>
    <li>3. Server Configuration</li>
    <li><a href="32-server-configuration-resources.html">3.2. Resourcing and labels</a></li>
  </ul>
</nav>
  <div style="padding: 0 0.5rem 0 0.75rem;"><a href="https://github.com/alvarolop" target="_blank" rel="noopener noreferrer"> © 2023 - Álvaro López Medina</a></div>
</div>  <div class="content">
<article class="doc">
<h1 class="page">Basic Configuration</h1>
<div class="sect1">
<h2 id="_high_availability"><a class="anchor" href="#_high_availability"></a>High availability</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In a production environment, you will always be interested in a high-availability configuration with several replicas, so that restarts don&#8217;t impact the availability of the Data Grid cluster. Enabling it is as simple as modifying the number of replicas of your cluster. You can play with the YAML definition to change the number of replicas.</p>
</div>
<div class="paragraph">
<p>First, configure three replicas of your cluster by modifying the following configuration:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: infinispan.org/v1
kind: Infinispan
metadata:
  name: cluster
spec:
# Here is the previous YAML content #
  replicas: 3</code></pre>
</div>
</div>
<div class="paragraph">
<p>Wait a few seconds, and you should see a larger list of pods. Execute the following command to monitor the deployment status:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc get pods -w</code></pre>
</div>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc get pods
NAME                                       READY   STATUS    RESTARTS   AGE
cluster-0                                  1/1     Running   0          21m
cluster-1                                  1/1     Running   0          4m40s
cluster-2                                  1/1     Running   0          4m33s
cluster-config-listener-7db8d897bc-ft59v   1/1     Running   0          21m</code></pre>
</div>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Did I Get It Right?</div>
<div class="paragraph">
<p>Access the logs of all the Data Grid pods to check that they clustered automagically and without errors. You should find logs like these in all the DG pods:</p>
</div>
<div class="listingblock">
<div class="title">cluster-2 logs</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-txt hljs" data-lang="txt">15:15:09,998 INFO  (main) [org.jgroups.protocols.FD_SOCK2] server listening on *.57800
15:15:10,047 INFO  (main) [org.infinispan.CLUSTER] ISPN000094: Received new cluster view for channel cluster: [cluster-0-34641|2] (3) [cluster-0-34641, cluster-1-35873, cluster-2-12580]
15:15:10,103 INFO  (main) [org.infinispan.CLUSTER] ISPN000079: Channel `cluster` local address is `cluster-2-12580`, physical addresses are `[10.131.1.63:7800]`
# ...
15:15:10,929 INFO  (non-blocking-thread--p2-t1) [org.infinispan.LIFECYCLE] [Context=___hotRodTopologyCache_hotrod-admin][Scope=cluster-2-12580]ISPN100010: Finished rebalance with members [cluster-0-34641, cluster-1-35873, cluster-2-12580], topology id 6
# ...
15:15:10,973 INFO  (main) [org.infinispan.SERVER] ISPN080001: Red Hat Data Grid Server 8.4.3.GA started in 2326ms</code></pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Please, before continuing to the next section, <strong>scale down the cluster to two replicas</strong> to save resources in Openshift.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_memory_and_cpu"><a class="anchor" href="#_memory_and_cpu"></a>Memory and CPU</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Mastering the control of requests and limits will form the cornerstone of your cache management expertise. It is as simple as adding the following configuration to your already running cluster. Please, do not just add this configuration at the end of the YAML, as the operator adds default values for memory. Look for the <code>container</code> section and add your values:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: infinispan.org/v1
kind: Infinispan
metadata:
  name: cluster
spec:
# Here the previous YAML content #
  container:
    cpu: "2000m:100m"
    memory: "1Gi:1Gi"</code></pre>
</div>
</div>
<div class="paragraph">
<p>After confirming the new definition of the Infinispan CR, the operator will trigger an ordered restart of the cluster with the new configuration ensuring that there is no loss of service.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>This configuration is <strong>strongly recommended</strong>. Many factors can affect the performance of Data Grid due to its nature as an in-memory cache. Even so, there are at least two common errors related to these settings:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Although most of the time, the CPU consumption will remain low, the CPU is crucial for the quick execution of the JVM Garbage collector. Therefore, limiting the CPU without proper analysis severely impacts performance.</p>
</li>
<li>
<p>The Data Grid image automatically calculates the bounds of the JVM Heap based on the container limit and request. For that reason, it is recommended to assign the same value for both parameters to avoid recalculations.</p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_jvm_settings"><a class="anchor" href="#_jvm_settings"></a>JVM settings</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To wrap up this segment on foundational settings, let&#8217;s delve into the option of incorporating additional JVM parameters. While you have the freedom to choose any parameter, some common ones include adjusting the timezone, configuring an alternate Garbage Collector, or setting up GC logs. For now, we&#8217;ll focus on modifying the timezone; later, you can explore the remaining options in the concluding section.</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: infinispan.org/v1
kind: Infinispan
metadata:
  name: cluster
spec:
# Here the previous YAML content #
  container:
    extraJvmOpts: '-Duser.timezone="Europe/Madrid"'
      # Here the MEM and CPU resources #</code></pre>
</div>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Did I Get It Right?</div>
<div class="paragraph">
<p>Access the logs of all the Data Grid pods to check the JVM parameters:</p>
</div>
<div class="listingblock">
<div class="title">cluster-0 logs</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-txt hljs" data-lang="txt">10:06:21,721 INFO (main) [BOOT] JVM OpenJDK 64-Bit Server VM Red Hat, Inc. 17.0.7+7-LTS
10:06:21,726 INFO (main) [BOOT] JVM arguments = [-server, --add-exports, java.naming/com.sun.jndi.ldap=ALL-UNNAMED, --add-opens, java.base/java.util=ALL-UNNAMED, --add-opens, java.base/java.util.concurrent=ALL-UNNAMED, -Xlog:gc*:file=/opt/infinispan/server/log/gc.log:time,uptimemillis:filecount=5,filesize=3M, -Duser.timezone=Europe/Madrid, -Xmx512m, -XX:+ExitOnOutOfMemoryError, -XX:MetaspaceSize=32m, -XX:MaxMetaspaceSize=96m, -Djava.net.preferIPv4Stack=true, -Djava.awt.headless=true, -Dvisualvm.display.name=redhat-datagrid-server, -Djava.util.logging.manager=org.infinispan.server.loader.LogManager, -Dinfinispan.server.home.path=/opt/infinispan, -classpath, :/opt/infinispan/boot/infinispan-server-runtime-14.0.11.Final-redhat-00001-loader.jar, org.infinispan.server.loader.Loader, org.infinispan.server.Bootstrap, --bind-address=0.0.0.0, -l, /opt/infinispan/server/conf/operator/log4j.xml, -c, operator/infinispan-base.xml, -c, operator/infinispan-admin.xml]</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see in the middle of the second log line, the <code>-Duser.timezone=Europe/Madrid</code> was concatenated to the JVM arguments and the log date/time is now correct.</p>
</div>
</div>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="31-server-configuration-basic.html">3.1. Initial Deployment</a></span>
  <span class="next"><a href="33-server-configuration-security.html">3.3. Security</a></span>
</nav>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer">
  <a class="rhd-logo" href="https://developers.redhat.com" target="_blank"></div>
</footer>
<script src="./_/js/vendor/clipboard.js"></script>
<script src="./_/js/site.js"></script>
<script async src="./_/js/vendor/highlight.js"></script>
  </body>
</html>
