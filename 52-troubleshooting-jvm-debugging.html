<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>JVM debugging :: RH Data Grid Workshop</title>
    <link rel="canonical" href="https://alvarolop.github.io/rhdg-workshop/52-troubleshooting-jvm-debugging.html">
    <link rel="prev" href="51-troubleshooting-rest-api.html">
    <link rel="next" href="60-exercises.html">
    <meta name="generator" content="Antora 3.0.3">
    <link rel="stylesheet" href="./_/css/site.css">
<link rel="icon" href="./_/img/favicon.ico" type="image/x-icon">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://developers.redhat.com" target="_blank"><img src="./_/img/RHDLogo.svg" height="40px" alt="Red Hat Developer Program"></a>
      <a class="navbar-item" style="font-size: 24px; color: white" href="https://alvarolop.github.io/rhdg-workshop">RH Data Grid Workshop</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="https://developers.redhat.com/ebooks/" target="_blank">Books</a>
        <a class="navbar-item" href="https://developers.redhat.com/cheatsheets/" target="_blank">Cheat Sheets</a>
        <a class="navbar-item" href="https://developers.redhat.com/events/" target="_blank">Upcoming Events</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">More Tutorials</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/quarkus-tutorial/" target="_blank">Quarkus</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/knative-tutorial/" target="_blank">Knative</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/kafka-tutorial/" target="_blank">Kafka</a>
            <a class="navbar-item" href="https://devsecops-workshop.github.io/" target="_blank">DevSecOps</a>
            <a class="navbar-item" href="https://acidonper.github.io/redhat-workshop-cicd-gitops/redhat-workshop-cicd-gitops/" target="_blank">CI/CD & GitOps</a>
            <a class="navbar-item" href="https://atarazana.github.io/gramola-gitops-guide/gramola-gitops-guide/" target="_blank">Gramola GitOps Guide</a>
            <a class="navbar-item" href="https://luisarizmendi.github.io/tutorial-secure-onboarding/" target="_blank">Secure Edge device onboarding with RHEL and FDO</a>
            <a class="navbar-item" href="https://xbryan1.github.io/rhte-2023-acm-docs/" target="_blank">Multicluster Application Deployment with Advanced Cluster Management and GitOps</a>
            <a class="navbar-item" href="https://redhat-scholars.github.io/java-inner-loop-dev-guide/java-inner-loop-dev-guide/index.html" target="_blank">Java Inner Loop Dev Guide</a>
          </div>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="ROOT" data-version="master">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html"></a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="10-introduction.html">1. Introduction</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="20-setup.html">2. Environment Setup</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">3. Server Configuration</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="31-server-configuration-basic.html">3.1. Initial Deployment</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="32-server-configuration-resources.html">3.2. Resourcing and labels</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="33-server-configuration-security.html">3.3. Security</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">4. Cache Configuration</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="40-cache-configuration-cache-crd.html">4.1. Cache CRD</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="41-cache-configuration-encoding.html">4.2. Encoding</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="42-cache-configuration-expiration.html">4.3. Expiration</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="43-cache-configuration-memory.html">4.4. Memory</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="44-cache-configuration-templates.html">4.5. Cache Templates</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">5. Troubleshooting</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="50-troubleshooting-basic.html">5.1. Basic Troubleshooting</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="51-troubleshooting-rest-api.html">5.2. REST to retrieve information</a>
  </li>
  <li class="nav-item is-current-page" data-depth="2">
    <a class="nav-link" href="52-troubleshooting-jvm-debugging.html">5.3. JVM debugging</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="60-exercises.html">6. Exercises</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="61-exercises-level-1.html">6.1. Level I</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="62-exercises-level-2.html">6.2. Level II</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="63-exercises-level-3.html">6.3. Level III</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="70-conclusions.html">7. Conclusions</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">RHDG Workshop</a></li>
    <li>5. Troubleshooting</li>
    <li><a href="52-troubleshooting-jvm-debugging.html">5.3. JVM debugging</a></li>
  </ul>
</nav>
  <div style="padding: 0 0.5rem 0 0.75rem;"><a href="https://github.com/alvarolop" target="_blank" rel="noopener noreferrer"> © 2023 - Álvaro López Medina</a></div>
</div>  <div class="content">
<article class="doc">
<h1 class="page">JVM debugging</h1>
<div class="sect1">
<h2 id="_java_thread_dump"><a class="anchor" href="#_java_thread_dump"></a>Java Thread Dump</h2>
<div class="sectionbody">
<div class="paragraph">
<p>A <strong>Java thread dump</strong> is a snapshot of what every thread in the JVM is doing at a particular point in time. Each thread in the JVM is listed with its name and ID, its current state and the Java call stack showing what monitor it has locked or is waiting on.</p>
</div>
<div class="listingblock console-input">
<div class="title">Get a Thread Dump</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">curl -s -k -u admin:password $RHDG_URL/rest/v2/server/threads</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_java_heap_dump"><a class="anchor" href="#_java_heap_dump"></a>Java Heap Dump</h2>
<div class="sectionbody">
<div class="paragraph">
<p>A <strong>Java Heap Dump</strong> is a snapshot of all the objects that are in memory in the JVM at a certain moment. They are very useful for troubleshooting memory leak problems and optimizing memory usage in Java applications. Heap dumps are usually stored in binary format <code>hprof</code> files.</p>
</div>
<div class="listingblock console-input">
<div class="title">Get a Heap Dump</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash"># Change "cache-replicated-01" to your desired cache name
curl -X POST -s -k -u admin:password $RHDG_URL/rest/v2/server/memory?action=heap-dump
# Take the filename from the output to copy it to your machine
oc cp cluster-0:/opt/infinispan/server/data/$DUMP_FILENAME.prof . heapdump-cluster-0.hprof</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_logging_gc_messages"><a class="anchor" href="#_logging_gc_messages"></a>Logging GC messages</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The Data Grid Operator does not log Garbage Collector (GC) messages by default. You can direct GC messages to stdout with the following JVM options:</p>
</div>
<div class="listingblock console-input">
<div class="title">Configure GC messages to stdout</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: infinispan.org/v1
kind: Infinispan
metadata:
  name: cluster
spec:
  container:
    # If you want to keep the timezone config, just append the following to the existing config
    extraJvmOpts: "-Xlog:gc*:stdout:time,level,tags"</code></pre>
</div>
</div>
<div class="paragraph">
<p>If instead, you want the logs in a separate file (as it might be quite verbose), you can use a configuration like the following:</p>
</div>
<div class="listingblock console-input">
<div class="title">Configure GC messages to file</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: infinispan.org/v1
kind: Infinispan
metadata:
  name: cluster
spec:
  container:
    # If you want to keep the timezone config, just append the following to the existing config
    extraJvmOpts: "-Xlog:gc*=info:file=/tmp/gc.log:time,level,tags,uptimemillis:filecount=10,filesize=1m"</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_analyzing_file_descriptions"><a class="anchor" href="#_analyzing_file_descriptions"></a>Analyzing File descriptions</h2>
<div class="sectionbody">
<div class="paragraph">
<p>A file descriptor is a number that uniquely identifies an open file in a computer&#8217;s operating system. It describes a data resource, and how that resource may be accessed. It is needed to open <strong>files</strong>, <strong>network sockets</strong>, etc. There is a <strong>default limit</strong> to the number of opened file descriptors. If you suspect that you are matching that limit, you can check with the following command:</p>
</div>
<div class="listingblock console-input">
<div class="title">Get the opened file descriptors</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc exec cluster-0 -- lsof -P &gt; lsof-cluster-0.txt</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_jdk_flight_recorder_jfr"><a class="anchor" href="#_jdk_flight_recorder_jfr"></a>JDK Flight Recorder (JFR)</h2>
<div class="sectionbody">
<div class="paragraph">
<p>JFR provides <strong>insights into various aspects of JVM performance</strong> to ease cluster inspection and debugging. Depending on your requirements, you can store and analyze your recordings using the integrated tools provided by Cryostat or export the recordings to an external monitoring application.</p>
</div>
<div class="paragraph">
<p><strong>Cryostat</strong> is a container-native Java application based on JDK Flight Recorder (JFR) that you can use to monitor Java Virtual Machine (JVM) performance for containerized workloads that run on a Red Hat OpenShift cluster.</p>
</div>
<div class="paragraph">
<p>The installation of the Cryostat and its dependency, the <code>cert-manager</code> operator is out of the scope of this workshop. Therefore, although it is part of the debugging options, we are not presenting detailed steps on how to generate a JFR using Cryostat.</p>
</div>
<div class="paragraph">
<p>Check the <a href="https://access.redhat.com/documentation/en-us/red_hat_data_grid/8.4/html/data_grid_operator_guide/monitoring-services#deploying-cryostat_monitor">JFR section in the Data Grid documentation</a> and the <a href="https://access.redhat.com/documentation/en-us/red_hat_build_of_cryostat/2/html-single/getting_started_with_cryostat/index#installing-cryostat-on-openshift-using-an-operator_cryostat">Getting started section of Cryostat</a> to get more information on how to install and configure it.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
If you want a simple guide on how to deploy the infrastructure for JFR and a walkthrough on Cryostat, check the <a href="https://github.com/alvarolop/rhdg8-server#7-java-flight-recorder">following GH repository</a>.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_useful_kcs"><a class="anchor" href="#_useful_kcs"></a>Useful KCS</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Do you have other needs and you would like to have the <code>jcmd</code> command inside the pod? Try the documentation of this KCS:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>KCS: <a href="https://access.redhat.com/solutions/6964022">Alternatives for creating heap dump and thread dump in a DG 8 even without the JDK</a>.</p>
</li>
<li>
<p>KCS: <a href="https://access.redhat.com/solutions/6968671">Troubleshoot options for Data Grid pod crash</a>.</p>
</li>
<li>
<p>KCS: <a href="https://access.redhat.com/solutions/6962483">Using inspect for DG 8 troubleshooting</a>.</p>
</li>
<li>
<p>KCS: <a href="https://access.redhat.com/solutions/6452611">DG 8 Troubleshooting steps for issues in OCP 4</a>.</p>
</li>
</ul>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="51-troubleshooting-rest-api.html">5.2. REST to retrieve information</a></span>
  <span class="next"><a href="60-exercises.html">6. Exercises</a></span>
</nav>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer">
  <a class="rhd-logo" href="https://developers.redhat.com" target="_blank"></div>
</footer>
<script src="./_/js/vendor/clipboard.js"></script>
<script src="./_/js/site.js"></script>
<script async src="./_/js/vendor/highlight.js"></script>
  </body>
</html>
